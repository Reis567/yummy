<!-- Modal Editar Lista -->
'<!-- Modal Editar Lista -->
<div class="modal fade" id="modalEditarLista" tabindex="-1" aria-labelledby="modalEditarListaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarListaLabel">
                    <i class="fas fa-edit me-2"></i>Editar Lista
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="formEditarLista">
                {% csrf_token %}
                <input type="hidden" id="editar_lista_id" name="id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editar_lista_nome" class="form-label">Nome da Lista*</label>
                        <input type="text" class="form-control" id="editar_lista_nome" name="nome" placeholder="Ex: Lista de Compras" required>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar_lista_objetivo" class="form-label">Objetivo</label>
                        <textarea class="form-control" id="editar_lista_objetivo" name="objetivo" rows="2" placeholder="Descreva o objetivo desta lista"></textarea>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar_lista_data_objetivo" class="form-label">Data para conclusão</label>
                        <input type="date" class="form-control" id="editar_lista_data_objetivo" name="data_objetivo">
                        <div class="form-text">Opcional: data limite para concluir esta lista</div>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="editar_lista_status" class="form-label">Status</label>
                            <select class="form-select" id="editar_lista_status" name="status">
                                <option value="pendente">Pendente</option>
                                <option value="em_andamento">Em andamento</option>
                                <option value="concluida">Concluída</option>
                                <option value="pausada">Pausada</option>
                                <option value="arquivada">Arquivada</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="col-6">
                            <label for="editar_lista_cor" class="form-label">Cor da Lista</label>
                            <input type="color" class="form-control form-control-color w-100" id="editar_lista_cor" name="cor" value="#F9A27B">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar_lista_icone" class="form-label">Ícone</label>
                        <div class="input-group">
                            <span class="input-group-text"><i id="editarIconPreview" class="fas fa-shopping-basket"></i></span>
                            <select class="form-select" id="editar_lista_icone" name="icone">
                                <option value="fas fa-shopping-basket">Cesta de Compras</option>
                                <option value="fas fa-utensils">Utensílios</option>
                                <option value="fas fa-tasks">Tarefas</option>
                                <option value="fas fa-briefcase">Trabalho</option>
                                <option value="fas fa-home">Casa</option>
                                <option value="fas fa-graduation-cap">Estudos</option>
                                <option value="fas fa-heart">Saúde</option>
                                <option value="fas fa-users">Família</option>
                                <option value="fas fa-dumbbell">Exercícios</option>
                                <option value="fas fa-plane">Viagens</option>
                                <option value="fas fa-gift">Presentes</option>
                                <option value="fas fa-book">Livros</option>
                                <option value="fas fa-film">Filmes</option>
                                <option value="fas fa-gamepad">Jogos</option>
                                <option value="fas fa-car">Transporte</option>
                                <option value="fas fa-money-bill-wave">Finanças</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex flex-column flex-sm-row w-100">
                        <button type="button" class="btn btn-outline-secondary mb-2 mb-sm-0 me-sm-2 order-2 order-sm-1" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary mb-2 mb-sm-0 order-1 order-sm-2 flex-fill">
                            <i class="fas fa-save me-1"></i> Salvar Alterações
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>



<script>


// Implementar edição de lista
$(document).on('click', '.edit-lista', function(e) {
    e.preventDefault();
    
    // Fechar menu de opções
    $('.lista-action-menu.show').removeClass('show');
    
    const listaId = $(this).data('lista-id');
    const listaCard = $(this).closest('.lista-card');
    
    // Preencher o formulário com os dados atuais da lista
    $('#editar_lista_id').val(listaId);
    $('#editar_lista_nome').val(listaCard.find('.lista-title').text().trim());
    $('#editar_lista_objetivo').val(listaCard.find('.lista-objetivo').text().trim());
    $('#editar_lista_status').val(listaCard.attr('class').split(' ').find(cls => ['pendente', 'em_andamento', 'concluida', 'pausada', 'arquivada'].includes(cls)));
    
    // Data objetivo (se existir)
    const dataObjetivoText = listaCard.find('.lista-meta span:contains("dias restantes")').text();
    if (dataObjetivoText) {
        // Aqui precisaríamos calcular a data objetivo a partir dos dias restantes
        // Como é complexo, você pode adicionar um atributo data-data-objetivo ao elemento HTML
        // Para simplificar, deixamos em branco por enquanto
        $('#editar_lista_data_objetivo').val('');
    } else {
        $('#editar_lista_data_objetivo').val('');
    }
    
    // Ícone atual
    const iconeClass = listaCard.find('.lista-icon i').attr('class');
    $('#editar_lista_icone').val(iconeClass);
    $('.icon-option').removeClass('selected');
    $(`.icon-option[data-icon="${iconeClass}"]`).addClass('selected');
    
    // Cor atual (você precisa ter o valor da cor armazenado)
    // Para simplificar, deixamos o padrão
    $('.color-option').removeClass('selected');
    $('.color-option:first').addClass('selected');
    $('#editar_lista_cor').val($('.color-option:first').data('color'));
    
    // Abrir o modal
    const editarListaModal = new bootstrap.Modal(document.getElementById('modalEditarLista'));
    editarListaModal.show();
});

// Seleção de ícone no modal de edição
$(document).on('click', '.icon-option', function() {
    $('.icon-option').removeClass('selected');
    $(this).addClass('selected');
    $('#editar_lista_icone').val($(this).data('icon'));
});

// Seleção de cor no modal de edição
$(document).on('click', '.color-option', function() {
    $('.color-option').removeClass('selected');
    $(this).addClass('selected');
    $('#editar_lista_cor').val($(this).data('color'));
});

// Salvar edição da lista
// Salvar edição da lista (versão corrigida)
$(document).on('click', '#salvarEdicaoLista', function() {
    const listaId = $('#editar_lista_id').val();
    
    // Obter dados do formulário
    const formData = {
        nome: $('#editar_lista_nome').val(),
        objetivo: $('#editar_lista_objetivo').val() || null, // Enviar null se estiver vazio
        status: $('#editar_lista_status').val(),
        data_objetivo: formatarDataParaBackend($('#editar_lista_data_objetivo').val()),
        icone: $('#editar_lista_icone').val(),
        cor: $('#editar_lista_cor').val()
    };
    
    // Validar campos obrigatórios
    let hasError = false;
    
    if (!formData.nome) {
        $('#editar_lista_nome').addClass('is-invalid');
        $('#editar_lista_nome').next('.invalid-feedback').text('O nome da lista é obrigatório.');
        hasError = true;
    }
    
    if (hasError) return;
    
    // Log para debug
    console.log('DEBUG: Enviando dados para atualização:', formData);
    
    // Enviar para a API
    $.ajax({
        url: `/api/listas/${listaId}/atualizar/`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        beforeSend: function(xhr) {
            xhr.setRequestHeader('X-CSRFToken', $('input[name="csrfmiddlewaretoken"]').val());
        },
        success: function(response) {
            console.log('DEBUG: Resposta de sucesso:', response);
            
            // Fechar o modal
            bootstrap.Modal.getInstance(document.getElementById('modalEditarLista')).hide();
            
            // Atualizar a lista na interface
            const listaCard = $(`.lista-card:has([data-lista-id="${listaId}"])`);
            
            // Atualizar título e objetivo
            listaCard.find('.lista-title').text(formData.nome);
            
            if (formData.objetivo) {
                if (listaCard.find('.lista-objetivo').length) {
                    listaCard.find('.lista-objetivo').text(formData.objetivo);
                } else {
                    listaCard.find('.lista-title').after(`<p class="lista-objetivo">${formData.objetivo}</p>`);
                }
            } else {
                listaCard.find('.lista-objetivo').remove();
            }
            
            // Atualizar ícone
            listaCard.find('.lista-icon i').attr('class', formData.icone);
            
            // Atualizar status
            listaCard.removeClass('pendente em_andamento concluida pausada arquivada');
            listaCard.addClass(formData.status);
            
            const statusBadge = listaCard.find('.badge-status');
            statusBadge.removeClass('pendente em_andamento concluida pausada arquivada');
            statusBadge.addClass(formData.status);
            statusBadge.text(response.lista.status_display);
            
            // Atualizar cor se aplicável
            if (formData.cor) {
                listaCard.data('cor', formData.cor);
                // Aqui podemos aplicar a cor visualmente se necessário
                // listaCard.find('.lista-icon').css('background-color', formData.cor);
            }
            
            // Exibir mensagem de sucesso
            showMessage('success', 'Lista atualizada com sucesso!', true);
            
            // Atualizar dashboard se necessário
            atualizarDashboardStatsLocalmente();
        },
        error: function(xhr, status, error) {
            console.error('DEBUG: Erro ao atualizar lista', { xhr, status, error });
            console.error('DEBUG: Resposta de erro:', xhr.responseText);
            
            // Tentar obter detalhes do erro
            let errorMessage = 'Erro ao atualizar a lista. Tente novamente.';
            let errors = {};
            
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.message) {
                    errorMessage = response.message;
                }
                if (response.errors) {
                    errors = response.errors;
                }
            } catch (e) {
                console.error('Erro ao parsing da resposta:', e);
            }
            
            // Exibir erros de validação
            if (Object.keys(errors).length > 0) {
                // Limpar erros anteriores
                $('#formEditarLista .invalid-feedback').empty();
                $('#formEditarLista .is-invalid').removeClass('is-invalid');
                
                // Adicionar novas mensagens de erro
                for (const field in errors) {
                    const fieldId = `#editar_lista_${field}`;
                    $(fieldId).addClass('is-invalid');
                    $(fieldId).next('.invalid-feedback').text(errors[field]);
                }
                
                showMessage('danger', 'Corrija os erros no formulário.', true);
            } else {
                showMessage('danger', errorMessage, true);
            }
        }
    });
});





</script>
