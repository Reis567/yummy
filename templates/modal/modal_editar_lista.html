<!-- Modal Editar Lista -->

<div class="modal fade" id="modalEditarLista" tabindex="-1" aria-labelledby="modalEditarListaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarListaLabel">
                    <i class="fas fa-edit me-2"></i>Editar Lista
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <form id="formEditarLista">
                {% csrf_token %}
                <input type="hidden" id="editar_lista_id" name="id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editar_lista_nome" class="form-label">Nome da Lista*</label>
                        <input type="text" class="form-control" id="editar_lista_nome" name="nome" placeholder="Ex: Lista de Compras" required>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar_lista_objetivo" class="form-label">Objetivo</label>
                        <textarea class="form-control" id="editar_lista_objetivo" name="objetivo" rows="2" placeholder="Descreva o objetivo desta lista"></textarea>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar_lista_data_objetivo" class="form-label">Data para conclusão</label>
                        <input type="date" class="form-control" id="editar_lista_data_objetivo" name="data_objetivo">
                        <div class="form-text">Opcional: data limite para concluir esta lista</div>
                        <div class="invalid-feedback"></div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-6">
                            <label for="editar_lista_status" class="form-label">Status</label>
                            <select class="form-select" id="editar_lista_status" name="status">
                                <option value="pendente">Pendente</option>
                                <option value="em_andamento">Em andamento</option>
                                <option value="concluida">Concluída</option>
                                <option value="pausada">Pausada</option>
                                <option value="arquivada">Arquivada</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="col-6">
                            <label for="editar_lista_cor" class="form-label">Cor da Lista</label>
                            <input type="color" class="form-control form-control-color w-100" id="editar_lista_cor" name="cor" value="#F9A27B">
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editar_lista_icone" class="form-label">Ícone</label>
                        <div class="input-group">
                            <span class="input-group-text"><i id="editarIconPreview" class="fas fa-shopping-basket"></i></span>
                            <select class="form-select" id="editar_lista_icone" name="icone">
                                <option value="fas fa-shopping-basket">Cesta de Compras</option>
                                <option value="fas fa-utensils">Utensílios</option>
                                <option value="fas fa-tasks">Tarefas</option>
                                <option value="fas fa-briefcase">Trabalho</option>
                                <option value="fas fa-home">Casa</option>
                                <option value="fas fa-graduation-cap">Estudos</option>
                                <option value="fas fa-heart">Saúde</option>
                                <option value="fas fa-users">Família</option>
                                <option value="fas fa-dumbbell">Exercícios</option>
                                <option value="fas fa-plane">Viagens</option>
                                <option value="fas fa-gift">Presentes</option>
                                <option value="fas fa-book">Livros</option>
                                <option value="fas fa-film">Filmes</option>
                                <option value="fas fa-gamepad">Jogos</option>
                                <option value="fas fa-car">Transporte</option>
                                <option value="fas fa-money-bill-wave">Finanças</option>
                            </select>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex flex-column flex-sm-row w-100">
                        <button type="button" class="btn btn-outline-secondary mb-2 mb-sm-0 me-sm-2 order-2 order-sm-1" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary mb-2 mb-sm-0 order-1 order-sm-2 flex-fill">
                            <i class="fas fa-save me-1"></i> Salvar Alterações
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>



<script>


// Função para formatar a data para o formato aceito pelo backend
function formatarDataParaBackend(dataString) {
    if (!dataString) return null;
    
    // Se já for uma data no formato ISO, retorna como está
    if (dataString.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return dataString;
    }
    
    try {
        // Converte para objeto Date e formata como YYYY-MM-DD
        const data = new Date(dataString);
        if (isNaN(data.getTime())) {
            return null; // Data inválida
        }
        return data.toISOString().split('T')[0];
    } catch (e) {
        console.error("Erro ao formatar data:", e);
        return null;
    }
}

// Função para formatar a data do formato backend (dd/mm/yyyy) para input date (yyyy-mm-dd)
function formatarDataParaInput(dataString) {
    if (!dataString) return '';
    
    // Verifica se a data já está no formato ISO
    if (dataString.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return dataString;
    }
    
    // Converte de DD/MM/YYYY para YYYY-MM-DD
    try {
        const partes = dataString.split('/');
        if (partes.length === 3) {
            return `${partes[2]}-${partes[1]}-${partes[0]}`;
        }
        return '';
    } catch (e) {
        console.error("Erro ao formatar data para input:", e);
        return '';
    }
}

// Implementar edição de lista
$(document).on('click', '.btn-lista-action.edit-lista, .edit-lista', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Fechar menu de opções se existir
    if ($('.lista-action-menu.show').length) {
        $('.lista-action-menu.show').removeClass('show');
    }
    
    const listaId = $(this).data('lista-id');
    const listaCard = $(this).closest('.lista-card');
    
    // Mostrar indicador de carregamento
    listaCard.addClass('loading');
    $('#modalEditarLista').addClass('loading');
    
    // Limpar erros anteriores
    $('#formEditarLista .invalid-feedback').empty();
    $('#formEditarLista .is-invalid').removeClass('is-invalid');
    
    // Buscar dados da lista via API
    $.ajax({
        url: `/api/listas/${listaId}/`,
        type: 'GET',
        success: function(response) {
            console.log('DEBUG: Dados da lista obtidos:', response);
            
            const lista = response.lista;
            
            // Preencher o formulário com os dados da lista
            $('#editar_lista_id').val(lista.id);
            $('#editar_lista_nome').val(lista.nome);
            $('#editar_lista_objetivo').val(lista.objetivo || '');
            $('#editar_lista_status').val(lista.status);
            
            // Formatar a data objetivo para o input date
            if (lista.data_objetivo) {
                $('#editar_lista_data_objetivo').val(formatarDataParaInput(lista.data_objetivo));
            } else {
                $('#editar_lista_data_objetivo').val('');
            }
            
            // Definir o ícone
            $('#editar_lista_icone').val(lista.icone);
            $('#editarIconPreview').attr('class', lista.icone);
            
            // Definir a cor
            $('#editar_lista_cor').val(lista.cor);
            
            // Remover indicador de carregamento
            listaCard.removeClass('loading');
            $('#modalEditarLista').removeClass('loading');
            
            // Abrir o modal
            const editarListaModal = new bootstrap.Modal(document.getElementById('modalEditarLista'));
            editarListaModal.show();
        },
        error: function(xhr, status, error) {
            console.error('DEBUG: Erro ao obter dados da lista', { xhr, status, error });
            
            // Remover indicador de carregamento
            listaCard.removeClass('loading');
            $('#modalEditarLista').removeClass('loading');
            
            // Mostrar mensagem de erro
            showMessage('danger', 'Erro ao carregar dados da lista. Tente novamente.', true);
        }
    });
});
// Adicionar esta função para lidar adequadamente com o fechamento do modal
function fecharModalEditarLista() {
    // 1. Remover o foco de todos os elementos dentro do modal
    $('#modalEditarLista button, #modalEditarLista input, #modalEditarLista select, #modalEditarLista textarea').blur();
    
    // 2. Definir o foco em um elemento fora do modal
    document.body.focus();
    
    // 3. Pequeno atraso antes de fechar o modal para garantir que o foco foi movido
    setTimeout(function() {
        try {
            const modalElement = document.getElementById('modalEditarLista');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
                
                // 4. Limpar resíduos após o fechamento
                $(modalElement).on('hidden.bs.modal', function() {
                    // Limpar manualmente todos os resíduos do modal
                    $(document.body).removeClass('modal-open');
                    $('.modal-backdrop').remove();
                    $(modalElement).css('display', 'none');
                    $(document.body).css('overflow', '');
                    $(document.body).css('padding-right', '');
                });
            }
        } catch (e) {
            console.warn('Erro ao fechar modal via Bootstrap:', e);
            // Fallback: fechar usando jQuery
            $('#modalEditarLista').modal('hide');
            
            // Limpar manualmente todos os resíduos
            setTimeout(function() {
                $(document.body).removeClass('modal-open');
                $('.modal-backdrop').remove();
                $('#modalEditarLista').css('display', 'none');
                $(document.body).css('overflow', '');
                $(document.body).css('padding-right', '');
            }, 300);
        }
    }, 50);
}

// Modificar o manipulador para o botão de fechar o modal
$(document).on('click', '[data-bs-dismiss="modal"]', function(e) {
    if ($(this).closest('#modalEditarLista').length) {
        e.preventDefault();
        fecharModalEditarLista();
    }
});

// Interceptar o evento Escape para também usar nosso método de fechamento personalizado
$(document).on('keydown', function(e) {
    if (e.key === 'Escape' && $('#modalEditarLista').hasClass('show')) {
        e.preventDefault();
        fecharModalEditarLista();
    }
});

// Quando o modal é fechado pelo clique no backdrop, também limpar o foco
$(document).on('click', '.modal-backdrop', function() {
    if ($('#modalEditarLista').hasClass('show')) {
        fecharModalEditarLista();
    }
});
// Atualização do preview de ícone quando o valor do select muda
$(document).on('change', '#editar_lista_icone', function() {
    const iconeClass = $(this).val();
    $('#editarIconPreview').attr('class', iconeClass);
});

// Handler para submissão do formulário de edição
$('#formEditarLista').on('submit', function(e) {
    e.preventDefault();
    
    const listaId = $('#editar_lista_id').val();
    
    // Mostrar indicador de carregamento
    $('#modalEditarLista').addClass('loading');
    
    // Obter dados do formulário
    const formData = {
        nome: $('#editar_lista_nome').val(),
        objetivo: $('#editar_lista_objetivo').val() || null, // Enviar null se estiver vazio
        status: $('#editar_lista_status').val(),
        data_objetivo: formatarDataParaBackend($('#editar_lista_data_objetivo').val()),
        icone: $('#editar_lista_icone').val(),
        cor: $('#editar_lista_cor').val()
    };
    
    // Validar campos obrigatórios
    let hasError = false;
    
    if (!formData.nome) {
        $('#editar_lista_nome').addClass('is-invalid');
        $('#editar_lista_nome').next('.invalid-feedback').text('O nome da lista é obrigatório.');
        hasError = true;
    }
    
    if (hasError) {
        $('#modalEditarLista').removeClass('loading');
        return;
    }
    
    // Log para debug
    console.log('DEBUG: Enviando dados para atualização:', formData);
    
    // Enviar para a API
    $.ajax({
        url: `/api/listas/${listaId}/atualizar/`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        beforeSend: function(xhr) {
            xhr.setRequestHeader('X-CSRFToken', $('input[name="csrfmiddlewaretoken"]').val());
        },
        success: function(response) {
            console.log('DEBUG: Resposta de sucesso:', response);
            
            // Remover indicador de carregamento
            $('#modalEditarLista').removeClass('loading');
            
            // Remover o foco de qualquer elemento dentro do modal
            $('#modalEditarLista button, #modalEditarLista input, #modalEditarLista select, #modalEditarLista textarea').blur();
            // Focar em um elemento fora do modal
            $('body').focus();
            
            // Fechar o modal corretamente
            try {
                const modalElement = document.getElementById('modalEditarLista');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                    
                    // Verificar e limpar efeitos residuais após fechamento
                    $(modalElement).on('hidden.bs.modal', function () {
                        // Remover classes e estilos residuais
                        $(document.body).removeClass('modal-open');
                        $('.modal-backdrop').remove();
                        $(modalElement).css('display', 'none');
                        $(document.body).css('overflow', '');
                        $(document.body).css('padding-right', '');
                    });
                }
            } catch (e) {
                console.warn('Erro ao fechar modal:', e);
                // Fallback: Usar jQuery para fechar
                $('#modalEditarLista').modal('hide');
                // Limpar manualmente
                $(document.body).removeClass('modal-open');
                $('.modal-backdrop').remove();
                $('#modalEditarLista').css('display', 'none');
                $(document.body).css('overflow', '');
                $(document.body).css('padding-right', '');
            }
            
            // Atualizar a lista na interface
            const listaCard = $(`.lista-card[data-lista-id="${listaId}"]`);
            
            // Atualizar título e objetivo
            listaCard.find('.lista-title').text(formData.nome);
            
            if (formData.objetivo) {
                if (listaCard.find('.lista-objetivo').length) {
                    listaCard.find('.lista-objetivo').text(formData.objetivo);
                } else {
                    listaCard.find('.lista-title').after(`<p class="lista-objetivo">${formData.objetivo}</p>`);
                }
            } else {
                listaCard.find('.lista-objetivo').remove();
            }
            
            // Atualizar ícone
            listaCard.find('.lista-icon i').attr('class', formData.icone);
            
            // Atualizar status
            listaCard.removeClass('pendente em_andamento concluida pausada arquivada');
            listaCard.addClass(formData.status);
            
            const statusBadge = listaCard.find('.badge-status');
            statusBadge.removeClass('pendente em_andamento concluida pausada arquivada');
            statusBadge.addClass(formData.status);
            statusBadge.text(response.lista.status_display);
            
            // Atualizar cor se aplicável
            if (formData.cor) {
                // Atualizar o atributo data e a propriedade data
                listaCard.attr('data-cor', formData.cor);
                listaCard.data('cor', formData.cor);
                
                // Aplicar a função dedicada para aplicar todas as cores
                aplicarCorPersonalizada(listaCard[0]);
            }
            
            // Aplicar efeito visual para feedback da atualização
            listaCard.addClass('update-pulse');
            setTimeout(function() {
                listaCard.removeClass('update-pulse');
            }, 1500);
            
            // Exibir mensagem de sucesso
            showMessage('success', 'Lista atualizada com sucesso!', true);
            
            // Atualizar dashboard se necessário
            atualizarDashboardStatsLocalmente();
        },
        error: function(xhr, status, error) {
            console.error('DEBUG: Erro ao atualizar lista', { xhr, status, error });
            console.error('DEBUG: Resposta de erro:', xhr.responseText);
            
            // Remover indicador de carregamento
            $('#modalEditarLista').removeClass('loading');
            
            // Tentar obter detalhes do erro
            let errorMessage = 'Erro ao atualizar a lista. Tente novamente.';
            let errors = {};
            
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.message) {
                    errorMessage = response.message;
                }
                if (response.errors) {
                    errors = response.errors;
                }
            } catch (e) {
                console.error('Erro ao parsing da resposta:', e);
            }
            
            // Exibir erros de validação
            if (Object.keys(errors).length > 0) {
                // Limpar erros anteriores
                $('#formEditarLista .invalid-feedback').empty();
                $('#formEditarLista .is-invalid').removeClass('is-invalid');
                
                // Adicionar novas mensagens de erro
                for (const field in errors) {
                    const fieldId = `#editar_lista_${field}`;
                    $(fieldId).addClass('is-invalid');
                    $(fieldId).next('.invalid-feedback').text(errors[field]);
                }
                
                showMessage('danger', 'Corrija os erros no formulário.', true);
            } else {
                showMessage('danger', errorMessage, true);
            }
        }
    });
});




</script>

<style>
/* Indicadores de carregamento para modal e card */
.loading {
    position: relative;
}

.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.7);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loading::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid transparent;
    border-top-color: var(--accent-color);
    border-bottom-color: var(--accent-color);
    z-index: 1001;
    animation: spinner 1s linear infinite;
}

/* Indicador de carregamento para o modal */
#modalEditarLista.loading::before {
    border-width: 4px;
    width: 50px;
    height: 50px;
}

/* Animação para o spinner */
@keyframes spinner {
    0% {
        transform: translate(-50%, -50%) rotate(0deg);
    }
    100% {
        transform: translate(-50%, -50%) rotate(360deg);
    }
}

/* Estilo para o loading pulse em botões */
.btn.loading {
    position: relative;
    pointer-events: none;
    color: transparent !important;
}

.btn.loading::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: inherit;
    opacity: 0.65;
    z-index: 1;
}

.btn.loading::before {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    border: 2px solid transparent;
    border-top-color: currentColor;
    border-right-color: currentColor;
    border-radius: 50%;
    z-index: 2;
    animation: spinner 0.8s linear infinite;
}

/* Um pulse visual para quando uma ação de edição foi aplicada (opcional) */
@keyframes update-pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(var(--accent-color-rgb), 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(var(--accent-color-rgb), 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(var(--accent-color-rgb), 0);
    }
}

.update-pulse {
    animation: update-pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) forwards;
}

/* Melhorar o design do input color */
input[type="color"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    width: 100%;
    height: 40px;
    padding: 0;
    border: none;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
}

input[type="color"]::-webkit-color-swatch-wrapper {
    padding: 0;
}

input[type="color"]::-webkit-color-swatch {
    border: none;
    border-radius: 4px;
    padding: 0;
}

input[type="color"]::-moz-color-swatch {
    border: none;
    border-radius: 4px;
    padding: 0;
}

/* Estilos para melhorar a visualização do modal durante carregamento */
#modalEditarLista.loading .modal-content {
    opacity: 0.8;
}

#modalEditarLista.loading .modal-body,
#modalEditarLista.loading .modal-footer {
    pointer-events: none;
}
</style>
