<!-- Modal Editar Lista com Geolocaliza√ß√£o -->
<div class="modal fade" id="modalEditarLista" tabindex="-1" aria-labelledby="modalEditarListaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarListaLabel">
                    <i class="fas fa-edit me-2"></i>Editar Lista
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            
            <form id="formEditarLista">
                {% csrf_token %}
                <input type="hidden" id="editar_lista_id" name="id">
                
                <div class="modal-body">
                    <!-- Navigation Tabs -->
                    <ul class="nav nav-tabs" id="editarListaTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="dados-tab" data-bs-toggle="tab" data-bs-target="#dados-pane" type="button" role="tab">
                                <i class="fas fa-info-circle me-1"></i>Dados Gerais
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="localizacao-tab" data-bs-toggle="tab" data-bs-target="#localizacao-pane" type="button" role="tab">
                                <i class="fas fa-map-marker-alt me-1"></i>Localiza√ß√£o
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="editarListaTabContent">
                        <!-- Aba Dados Gerais -->
                        <div class="tab-pane fade show active" id="dados-pane" role="tabpanel">
                            <div class="mb-3">
                                <label for="editar_lista_nome" class="form-label">Nome da Lista*</label>
                                <input type="text" class="form-control" id="editar_lista_nome" name="nome" placeholder="Ex: Lista de Compras" required>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editar_lista_objetivo" class="form-label">Objetivo</label>
                                <textarea class="form-control" id="editar_lista_objetivo" name="objetivo" rows="2" placeholder="Descreva o objetivo desta lista"></textarea>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editar_lista_data_objetivo" class="form-label">Data para conclus√£o</label>
                                <input type="date" class="form-control" id="editar_lista_data_objetivo" name="data_objetivo">
                                <div class="form-text">Opcional: data limite para concluir esta lista</div>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label for="editar_lista_status" class="form-label">Status</label>
                                    <select class="form-select" id="editar_lista_status" name="status">
                                        <option value="em_andamento">Em andamento</option>
                                        <option value="concluida">Conclu√≠da</option>
                                        <option value="pausada">Pausada</option>
                                        <option value="arquivada">Arquivada</option>
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                                
                                <div class="col-6">
                                    <label for="editar_lista_cor" class="form-label">Cor da Lista</label>
                                    <input type="color" class="form-control form-control-color w-100" id="editar_lista_cor" name="cor" value="#F9A27B">
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="editar_lista_icone" class="form-label">√çcone</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i id="editarIconPreview" class="fas fa-shopping-basket"></i></span>
                                    <select class="form-select" id="editar_lista_icone" name="icone">
                                        <option value="fas fa-shopping-basket">Cesta de Compras</option>
                                        <option value="fas fa-utensils">Utens√≠lios</option>
                                        <option value="fas fa-tasks">Tarefas</option>
                                        <option value="fas fa-briefcase">Trabalho</option>
                                        <option value="fas fa-home">Casa</option>
                                        <option value="fas fa-graduation-cap">Estudos</option>
                                        <option value="fas fa-heart">Sa√∫de</option>
                                        <option value="fas fa-users">Fam√≠lia</option>
                                        <option value="fas fa-dumbbell">Exerc√≠cios</option>
                                        <option value="fas fa-plane">Viagens</option>
                                        <option value="fas fa-gift">Presentes</option>
                                        <option value="fas fa-book">Livros</option>
                                        <option value="fas fa-film">Filmes</option>
                                        <option value="fas fa-gamepad">Jogos</option>
                                        <option value="fas fa-car">Transporte</option>
                                        <option value="fas fa-money-bill-wave">Finan√ßas</option>
                                        <option value="fas fa-map-marker-alt">Localiza√ß√£o</option>
                                    </select>
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aba Localiza√ß√£o -->
                        <div class="tab-pane fade" id="localizacao-pane" role="tabpanel">
                            <!-- Status da Geolocaliza√ß√£o -->
                            <div id="geo-status-container"></div>
                            
                            <!-- Campo de Endere√ßo -->
                            <div class="mb-3">
                                <label for="editar_lista_endereco" class="form-label">Endere√ßo</label>
                                <div class="endereco-group">
                                    <input type="text" class="form-control" id="editar_lista_endereco" name="endereco" placeholder="Digite o endere√ßo ou local relacionado a esta lista">
                                    <button type="button" class="btn-search-address" id="btnBuscarEndereco" title="Buscar no mapa">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div class="form-text">Opcional: endere√ßo relacionado √† lista (ex: supermercado, escrit√≥rio)</div>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <!-- Controles do Mapa -->
                            <div class="map-controls">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-map-action" id="btnLocalizarMe">
                                        <i class="fas fa-crosshairs me-1"></i>Minha Localiza√ß√£o
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-map-action" id="btnLimparMapa">
                                        <i class="fas fa-eraser me-1"></i>Limpar
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Container do Mapa -->
                            <div id="map-container"></div>
                            
                            <!-- Exibi√ß√£o das Coordenadas -->
                            <div id="coordinates-display" class="coordinates-display" style="display: none;">
                                <strong>Coordenadas:</strong> <span id="coordinates-text"></span>
                            </div>
                            
                            <!-- Campos ocultos para latitude e longitude -->
                            <input type="hidden" id="editar_lista_latitude" name="latitude">
                            <input type="hidden" id="editar_lista_longitude" name="longitude">
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <div class="d-flex flex-column flex-sm-row w-100">
                        <button type="button" class="btn btn-outline-secondary mb-2 mb-sm-0 me-sm-2 order-2 order-sm-1" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary mb-2 mb-sm-0 order-1 order-sm-2 flex-fill">
                            <i class="fas fa-save me-1"></i> Salvar Altera√ß√µes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- CSS Adicional para Geolocaliza√ß√£o -->
<style>
    /* Vari√°veis CSS para cores consistentes */
    :root {
        --primary-color: #FF6B6B;
        --accent-color: #F9A27B;
        --accent-color-rgb: 249, 162, 123;
        --tertiary-color: #FFF5F5;
        --secondary-color: #F0F0F0;
        --text-dark: #2C3E50;
        --text-muted: #7F8C8D;
        --success-color: #2ECC71;
        --warning-color: #F39C12;
        --error-color: #E74C3C;
        --error-color-rgb: 231, 76, 60;
    }

    /* Estilo do mapa */
    #map-container {
        height: 200px;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid var(--secondary-color);
        transition: border-color 0.3s ease;
        background-color: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 0.9rem;
        position: relative;
    }

    #map-container:hover {
        border-color: var(--accent-color);
    }

    #map-container.map-loaded {
        background-color: transparent;
    }

    .map-controls {
        margin-bottom: 15px;
    }

    .btn-map-action {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
    }

    /* Estilo para o campo de endere√ßo */
    .endereco-group {
        position: relative;
    }

    .btn-search-address {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: var(--accent-color);
        color: white;
        border-radius: 4px;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 5;
    }

    .btn-search-address:hover {
        background: var(--primary-color);
        transform: translateY(-50%) scale(1.05);
    }

    /* Indicadores de status de geolocaliza√ß√£o */
    .geo-status {
        display: inline-flex;
        align-items: center;
        font-size: 0.875rem;
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
        margin-bottom: 15px;
        border: 1px solid transparent;
    }

    .geo-status.success {
        background-color: rgba(46, 204, 113, 0.1);
        color: var(--success-color);
        border-color: rgba(46, 204, 113, 0.3);
    }

    .geo-status.warning {
        background-color: rgba(243, 156, 18, 0.1);
        color: var(--warning-color);
        border-color: rgba(243, 156, 18, 0.3);
    }

    .geo-status.error {
        background-color: rgba(231, 76, 60, 0.1);
        color: var(--error-color);
        border-color: rgba(231, 76, 60, 0.3);
    }

    /* Coordenadas */
    .coordinates-display {
        font-family: 'Courier New', monospace;
        font-size: 0.8rem;
        color: var(--text-muted);
        background-color: var(--tertiary-color);
        padding: 0.75rem;
        border-radius: 6px;
        margin-top: 15px;
        border: 1px solid var(--secondary-color);
    }

    /* Abas para organizar o modal */
    .nav-tabs {
        border-bottom: 2px solid var(--secondary-color);
        margin-bottom: 0;
    }

    .nav-tabs .nav-link {
        border: none;
        color: var(--text-muted);
        font-weight: 600;
        padding: 0.75rem 1rem;
        border-radius: 0;
        transition: all 0.3s ease;
    }

    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
        background-color: rgba(var(--accent-color-rgb), 0.1);
    }

    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        border-bottom: 3px solid var(--primary-color);
        background: none;
        font-weight: 700;
    }

    .tab-content {
        padding-top: 20px;
    }

    /* Modal responsivo */
    @media (min-width: 768px) {
        .modal-lg {
            max-width: 800px;
        }
        
        #map-container {
            height: 250px;
        }
    }

    @media (max-width: 576px) {
        .modal-dialog {
            margin: 10px;
            max-width: calc(100% - 20px);
        }
        
        #map-container {
            height: 180px;
        }
        
        .nav-tabs .nav-link {
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
        }
    }

    /* Indicadores de carregamento - mantendo os existentes */
    .loading {
        position: relative;
    }

    .loading::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .loading::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid transparent;
        border-top-color: var(--accent-color);
        border-bottom-color: var(--accent-color);
        z-index: 1001;
        animation: spinner 1s linear infinite;
    }

    #modalEditarLista.loading::before {
        border-width: 4px;
        width: 50px;
        height: 50px;
    }

    @keyframes spinner {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Melhorar design do input color - mantendo os existentes */
    input[type="color"] {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 100%;
        height: 40px;
        padding: 0;
        border: none;
        border-radius: 4px;
        overflow: hidden;
        cursor: pointer;
    }

    input[type="color"]::-webkit-color-swatch-wrapper {
        padding: 0;
    }

    input[type="color"]::-webkit-color-swatch {
        border: none;
        border-radius: 4px;
    }

    input[type="color"]::-moz-color-swatch {
        border: none;
        border-radius: 4px;
    }

    /* Anima√ß√£o de atualiza√ß√£o - mantendo a existente */
    @keyframes update-pulse {
        0% { box-shadow: 0 0 0 0 rgba(var(--accent-color-rgb), 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(var(--accent-color-rgb), 0); }
        100% { box-shadow: 0 0 0 0 rgba(var(--accent-color-rgb), 0); }
    }

    .update-pulse {
        animation: update-pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) forwards;
    }

    /* Melhorias de loading para modal */
    #modalEditarLista.loading .modal-content {
        opacity: 0.9;
    }

    #modalEditarLista.loading .modal-body,
    #modalEditarLista.loading .modal-footer {
        pointer-events: none;
    }

    /* Estado inicial do mapa */
    #map-container::before {
        content: 'üó∫Ô∏è Clique em "Minha Localiza√ß√£o" ou "Buscar" para carregar o mapa';
        text-align: center;
        opacity: 0.7;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 80%;
    }

    #map-container.map-loaded::before {
        display: none;
    }

    #editarListaTabs li button {
        color: var(--primary-color) !important;
    }

    /* Indicador visual de localiza√ß√£o no card */
    .location-indicator {
        font-size: 0.75rem;
        color: var(--primary-color);
        font-weight: 600;
    }
</style>

<script>
$(document).ready(function() {
    // Verificar se Leaflet j√° est√° carregado
    if (typeof L === 'undefined') {
        // Carregar Leaflet CSS
        if (!$('link[href*="leaflet"]').length) {
            $('<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">').appendTo('head');
        }
        
        // Carregar Leaflet JS
        $.getScript('https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js')
            .done(function() {
                console.log('Leaflet carregado com sucesso');
                window.leafletLoaded = true;
            })
            .fail(function() {
                console.error('Erro ao carregar Leaflet');
            });
    } else {
        window.leafletLoaded = true;
    }
});

// Objeto para gerenciar o mapa e suas funcionalidades
const MapaEditarLista = {
    // Propriedades
    mapa: null,
    marcador: null,
    inicializado: false,
    
    // Coordenadas padr√£o (Maric√°, RJ)
    coordenadasPadrao: {
        lat: -22.9194,
        lng: -42.8186,
        zoom: 12
    },
    
    // M√©todos
    init: function() {
        if (this.inicializado || typeof L === 'undefined') {
            return false;
        }
        
        try {
            console.log('Inicializando mapa...');
            
            // Criar mapa
            this.mapa = L.map('map-container').setView(
                [this.coordenadasPadrao.lat, this.coordenadasPadrao.lng], 
                this.coordenadasPadrao.zoom
            );
            
            // Adicionar camada de tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(this.mapa);
            
            // Marcar container como carregado
            $('#map-container').addClass('map-loaded');
            
            // Adicionar evento de clique
            this.mapa.on('click', (e) => {
                this.definirLocalizacao(e.latlng.lat, e.latlng.lng);
            });
            
            this.inicializado = true;
            this.mostrarStatus('success', 'Mapa carregado! Clique no mapa para definir a localiza√ß√£o.');
            
            return true;
            
        } catch (error) {
            console.error('Erro ao inicializar mapa:', error);
            this.mostrarStatus('error', 'Erro ao carregar o mapa. Verifique sua conex√£o.');
            return false;
        }
    },
    
    definirLocalizacao: function(lat, lng, endereco = null) {
        if (!this.mapa) {
            console.error('Mapa n√£o inicializado');
            return;
        }
        
        // Remover marcador anterior
        if (this.marcador) {
            this.mapa.removeLayer(this.marcador);
        }
        
        // Adicionar novo marcador
        this.marcador = L.marker([lat, lng]).addTo(this.mapa);
        this.mapa.setView([lat, lng], 15);
        
        // Atualizar campos do formul√°rio
        $('#editar_lista_latitude').val(lat.toFixed(6));
        $('#editar_lista_longitude').val(lng.toFixed(6));
        
        // Exibir coordenadas
        $('#coordinates-text').text(`${lat.toFixed(6)}, ${lng.toFixed(6)}`);
        $('#coordinates-display').show();
        
        // Atualizar endere√ßo se fornecido
        if (endereco) {
            $('#editar_lista_endereco').val(endereco);
        }
        
        this.mostrarStatus('success', 'Localiza√ß√£o definida com sucesso!');
    },
    
    obterLocalizacaoAtual: function() {
        if (!navigator.geolocation) {
            this.mostrarStatus('error', 'Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador.');
            return;
        }
        
        // Inicializar mapa se necess√°rio
        if (!this.inicializado) {
            const inicializado = this.init();
            if (!inicializado) {
                setTimeout(() => this.obterLocalizacaoAtual(), 1000);
                return;
            }
        }
        
        this.mostrarStatus('warning', 'Obtendo sua localiza√ß√£o...');
        
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                this.definirLocalizacao(lat, lng);
                
                // Tentar obter endere√ßo via geocoding reverso
                this.geocodingReverso(lat, lng);
            },
            (error) => {
                let message = 'Erro ao obter localiza√ß√£o.';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'Permiss√£o de localiza√ß√£o negada pelo usu√°rio.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'Localiza√ß√£o indispon√≠vel no momento.';
                        break;
                    case error.TIMEOUT:
                        message = 'Tempo limite para obter localiza√ß√£o.';
                        break;
                }
                this.mostrarStatus('error', message);
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000
            }
        );
    },
    
    buscarEndereco: function() {
        const endereco = $('#editar_lista_endereco').val().trim();
        if (!endereco) {
            this.mostrarStatus('warning', 'Digite um endere√ßo para buscar.');
            return;
        }
        
        // Inicializar mapa se necess√°rio
        if (!this.inicializado) {
            const inicializado = this.init();
            if (!inicializado) {
                setTimeout(() => this.buscarEndereco(), 1000);
                return;
            }
        }
        
        this.mostrarStatus('warning', 'Buscando endere√ßo...');
        
        // Adicionar bias para a regi√£o do Rio de Janeiro
        const query = encodeURIComponent(`${endereco}, Rio de Janeiro, Brasil`);
        
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1&countrycodes=br`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const result = data[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);
                    this.definirLocalizacao(lat, lng, result.display_name);
                } else {
                    this.mostrarStatus('error', 'Endere√ßo n√£o encontrado. Tente ser mais espec√≠fico.');
                }
            })
            .catch(error => {
                console.error('Erro na busca:', error);
                this.mostrarStatus('error', 'Erro ao buscar endere√ßo. Verifique sua conex√£o.');
            });
    },
    
    geocodingReverso: function(lat, lng) {
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`)
            .then(response => response.json())
            .then(data => {
                if (data.display_name) {
                    $('#editar_lista_endereco').val(data.display_name);
                }
            })
            .catch(error => {
                console.log('N√£o foi poss√≠vel obter o endere√ßo automaticamente:', error);
            });
    },
    
    limparLocalizacao: function() {
        if (this.marcador && this.mapa) {
            this.mapa.removeLayer(this.marcador);
            this.marcador = null;
        }
        
        $('#editar_lista_latitude').val('');
        $('#editar_lista_longitude').val('');
        $('#editar_lista_endereco').val('');
        $('#coordinates-display').hide();
        
        this.mostrarStatus('warning', 'Localiza√ß√£o removida.');
    },
    
    carregarDados: function(lista) {
        if (lista.endereco) {
            $('#editar_lista_endereco').val(lista.endereco);
        }
        
        if (lista.latitude && lista.longitude) {
            $('#editar_lista_latitude').val(lista.latitude);
            $('#editar_lista_longitude').val(lista.longitude);
            
            // Se o mapa estiver inicializado, mostrar a localiza√ß√£o
            if (this.inicializado) {
                this.definirLocalizacao(parseFloat(lista.latitude), parseFloat(lista.longitude), lista.endereco);
            }
            
            // Mostrar coordenadas
            $('#coordinates-text').text(`${lista.latitude}, ${lista.longitude}`);
            $('#coordinates-display').show();
            
            this.mostrarStatus('success', 'Localiza√ß√£o carregada da lista.');
        }
    },
    
    mostrarStatus: function(tipo, mensagem) {
        const container = $('#geo-status-container');
        const icone = tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'times-circle';
        
        container.html(`
            <div class="geo-status ${tipo}">
                <i class="fas fa-${icone} me-2"></i>
                ${mensagem}
            </div>
        `);
    },
    
    resetar: function() {
        // Limpar dados de geolocaliza√ß√£o
        $('#geo-status-container').empty();
        $('#coordinates-display').hide();
        
        // Resetar mapa se necess√°rio
        if (this.marcador && this.mapa) {
            this.mapa.removeLayer(this.marcador);
            this.marcador = null;
        }
        
        // Limpar campos
        $('#editar_lista_endereco').val('');
        $('#editar_lista_latitude').val('');
        $('#editar_lista_longitude').val('');
    }
};

// Fun√ß√µes de formata√ß√£o de data (mantendo as existentes)
function formatarDataParaBackend(dataString) {
    if (!dataString) return null;
    
    if (dataString.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return dataString;
    }
    
    try {
        const data = new Date(dataString);
        if (isNaN(data.getTime())) {
            return null;
        }
        return data.toISOString().split('T')[0];
    } catch (e) {
        console.error("Erro ao formatar data:", e);
        return null;
    }
}

function formatarDataParaInput(dataString) {
    if (!dataString) return '';
    
    if (dataString.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return dataString;
    }
    
    try {
        const partes = dataString.split('/');
        if (partes.length === 3) {
            return `${partes[2]}-${partes[1]}-${partes[0]}`;
        }
        return '';
    } catch (e) {
        console.error("Erro ao formatar data para input:", e);
        return '';
    }
}

// Event Listeners
$(document).ready(function() {
    // Inicializar mapa quando a aba de localiza√ß√£o for clicada
    $(document).on('click', '#localizacao-tab', function() {
        setTimeout(function() {
            if (window.leafletLoaded || typeof L !== 'undefined') {
                MapaEditarLista.init();
            } else {
                console.log('Aguardando carregamento do Leaflet...');
                setTimeout(function() {
                    MapaEditarLista.init();
                }, 500);
            }
        }, 150);
    });
    
    // Bot√£o de localiza√ß√£o atual
    $(document).on('click', '#btnLocalizarMe', function(e) {
        e.preventDefault();
        MapaEditarLista.obterLocalizacaoAtual();
    });
    
    // Bot√£o de buscar endere√ßo
    $(document).on('click', '#btnBuscarEndereco', function(e) {
        e.preventDefault();
        MapaEditarLista.buscarEndereco();
    });
    
    // Bot√£o de limpar
    $(document).on('click', '#btnLimparMapa', function(e) {
        e.preventDefault();
        MapaEditarLista.limparLocalizacao();
    });
    
    // Enter no campo de endere√ßo
    $(document).on('keypress', '#editar_lista_endereco', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            MapaEditarLista.buscarEndereco();
        }
    });
    
    // Preview do √≠cone
    $(document).on('change', '#editar_lista_icone', function() {
        const iconeClass = $(this).val();
        $('#editarIconPreview').attr('class', iconeClass);
    });
    
    // Resetar dados do mapa quando o modal for fechado
    $('#modalEditarLista').on('hidden.bs.modal', function() {
        MapaEditarLista.resetar();
        // Voltar para a primeira aba
        $('#dados-tab').tab('show');
        
        // Limpar res√≠duos e corrigir problemas de acessibilidade
        setTimeout(function() {
            // Remover classes e estilos residuais
            $(document.body).removeClass('modal-open');
            $('.modal-backdrop').remove();
            $('#modalEditarLista').css('display', 'none').removeAttr('style');
            $(document.body).css('overflow', '').css('padding-right', '');
            
            // Remover aria-hidden que pode causar conflitos
            $('#modalEditarLista').removeAttr('aria-hidden');
        }, 100);
    });
    
    // Handler espec√≠fico para o bot√£o de fechar
    $(document).on('click', '[data-bs-dismiss="modal"]', function(e) {
        if ($(this).closest('#modalEditarLista').length) {
            // Remover foco do bot√£o antes de fechar
            $(this).blur();
            
            // Pequeno delay para garantir que o blur aconte√ßa
            setTimeout(function() {
                // Focar em um elemento seguro fora do modal
                document.body.focus();
            }, 10);
        }
    });
    
    // Handler para tecla Escape
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape' && $('#modalEditarLista').hasClass('show')) {
            // Remover foco de qualquer elemento focado dentro do modal
            $('#modalEditarLista button, #modalEditarLista input, #modalEditarLista select, #modalEditarLista textarea').blur();
            
            // Focar no body
            document.body.focus();
            
            // Pequeno delay antes de fechar
            setTimeout(function() {
                const modalElement = document.getElementById('modalEditarLista');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }, 10);
        }
    });
    
    // Handler para clique no backdrop
    $(document).on('click', function(e) {
        if ($(e.target).hasClass('modal') && $(e.target).attr('id') === 'modalEditarLista') {
            // Remover foco de elementos dentro do modal
            $('#modalEditarLista button, #modalEditarLista input, #modalEditarLista select, #modalEditarLista textarea').blur();
            document.body.focus();
        }
    });
});

// Handler de edi√ß√£o de lista (integrado com as funcionalidades existentes)
$(document).on('click', '.btn-lista-action.edit-lista, .edit-lista', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Fechar menu de op√ß√µes se existir
    if ($('.lista-action-menu.show').length) {
        $('.lista-action-menu.show').removeClass('show');
    }
    
    const listaId = $(this).data('lista-id');
    const listaCard = $(this).closest('.lista-card');
    
    // Mostrar indicador de carregamento
    listaCard.addClass('loading');
    $('#modalEditarLista').addClass('loading');
    
    // Limpar erros anteriores
    $('#formEditarLista .invalid-feedback').empty();
    $('#formEditarLista .is-invalid').removeClass('is-invalid');
    
    // Resetar dados do mapa
    MapaEditarLista.resetar();
    
    // Buscar dados da lista via API
    $.ajax({
        url: `/api/listas/${listaId}/`,
        type: 'GET',
        success: function(response) {
            console.log('DEBUG: Dados da lista obtidos:', response);
            
            const lista = response.lista;
            
            // Preencher formul√°rio com dados gerais
            $('#editar_lista_id').val(lista.id);
            $('#editar_lista_nome').val(lista.nome);
            $('#editar_lista_objetivo').val(lista.objetivo || '');
            $('#editar_lista_status').val(lista.status);
            
            // Formatar data objetivo
            if (lista.data_objetivo) {
                $('#editar_lista_data_objetivo').val(formatarDataParaInput(lista.data_objetivo));
            } else {
                $('#editar_lista_data_objetivo').val('');
            }
            
            // Definir √≠cone e cor
            $('#editar_lista_icone').val(lista.icone);
            $('#editarIconPreview').attr('class', lista.icone);
            $('#editar_lista_cor').val(lista.cor);
            
            // Carregar dados de geolocaliza√ß√£o
            MapaEditarLista.carregarDados(lista);
            
            // Remover indicador de carregamento
            listaCard.removeClass('loading');
            $('#modalEditarLista').removeClass('loading');
            
            // Abrir modal
            const editarListaModal = new bootstrap.Modal(document.getElementById('modalEditarLista'));
            editarListaModal.show();
        },
        error: function(xhr, status, error) {
            console.error('DEBUG: Erro ao obter dados da lista', { xhr, status, error });
            
            // Remover indicador de carregamento
            listaCard.removeClass('loading');
            $('#modalEditarLista').removeClass('loading');
            
            // Mostrar mensagem de erro
            if (typeof showMessage === 'function') {
                showMessage('danger', 'Erro ao carregar dados da lista. Tente novamente.', true);
            }
        }
    });
});

// Handler de submiss√£o do formul√°rio
$('#formEditarLista').on('submit', function(e) {
    e.preventDefault();
    
    const listaId = $('#editar_lista_id').val();
    
    // Mostrar indicador de carregamento
    $('#modalEditarLista').addClass('loading');
    
    // Coletar dados do formul√°rio
    const formData = {
        nome: $('#editar_lista_nome').val(),
        objetivo: $('#editar_lista_objetivo').val() || null,
        status: $('#editar_lista_status').val(),
        data_objetivo: formatarDataParaBackend($('#editar_lista_data_objetivo').val()),
        icone: $('#editar_lista_icone').val(),
        cor: $('#editar_lista_cor').val(),
        // Dados de geolocaliza√ß√£o
        endereco: $('#editar_lista_endereco').val() || null,
        latitude: $('#editar_lista_latitude').val() || null,
        longitude: $('#editar_lista_longitude').val() || null
    };
    
    // Validar campos obrigat√≥rios
    let hasError = false;
    
    // Limpar erros anteriores
    $('#formEditarLista .invalid-feedback').empty();
    $('#formEditarLista .is-invalid').removeClass('is-invalid');
    
    if (!formData.nome.trim()) {
        $('#editar_lista_nome').addClass('is-invalid');
        $('#editar_lista_nome').next('.invalid-feedback').text('O nome da lista √© obrigat√≥rio.');
        hasError = true;
    }
    
    if (hasError) {
        $('#modalEditarLista').removeClass('loading');
        return;
    }
    
    console.log('DEBUG: Enviando dados para atualiza√ß√£o:', formData);
    
    // Enviar para API
    $.ajax({
        url: `/api/listas/${listaId}/atualizar/`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        beforeSend: function(xhr) {
            xhr.setRequestHeader('X-CSRFToken', $('input[name="csrfmiddlewaretoken"]').val());
        },
        success: function(response) {
            console.log('DEBUG: Resposta de sucesso:', response);
            
            // Remover indicador de carregamento
            $('#modalEditarLista').removeClass('loading');
            
            // Fechar modal
            if (typeof fecharModalEditarLista === 'function') {
                fecharModalEditarLista();
            } else {
                const modalElement = document.getElementById('modalEditarLista');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                if (modalInstance) {
                    modalInstance.hide();
                }
            }
            
            // Atualizar interface
            const listaCard = $(`.lista-card[data-lista-id="${listaId}"]`);
            
            // Atualizar t√≠tulo e objetivo
            listaCard.find('.lista-title').text(formData.nome);
            
            if (formData.objetivo) {
                if (listaCard.find('.lista-objetivo').length) {
                    listaCard.find('.lista-objetivo').text(formData.objetivo);
                } else {
                    listaCard.find('.lista-title').after(`<p class="lista-objetivo">${formData.objetivo}</p>`);
                }
            } else {
                listaCard.find('.lista-objetivo').remove();
            }
            
            // Atualizar √≠cone
            listaCard.find('.lista-icon i').attr('class', formData.icone);
            
            // Atualizar status
            listaCard.removeClass('em_andamento concluida pausada arquivada');
            listaCard.addClass(formData.status);
            
            const statusBadge = listaCard.find('.badge-status');
            statusBadge.removeClass('em_andamento concluida pausada arquivada');
            statusBadge.addClass(formData.status);
            statusBadge.text(response.lista.status_display);
            
            // Atualizar cor
            if (formData.cor) {
                listaCard.attr('data-cor', formData.cor);
                listaCard.data('cor', formData.cor);
                
                if (typeof aplicarCorPersonalizada === 'function') {
                    aplicarCorPersonalizada(listaCard[0]);
                }
            }
            
            // Indicador de localiza√ß√£o
            if (formData.latitude && formData.longitude) {
                // Adicionar indicador de localiza√ß√£o se n√£o existir
                if (listaCard.find('.location-indicator').length === 0) {
                    listaCard.find('.lista-meta').append(`
                        <span class="location-indicator" title="Esta lista possui localiza√ß√£o definida">
                            <i class="fas fa-map-marker-alt me-1"></i>Localizada
                        </span>
                    `);
                }
            } else {
                // Remover indicador se n√£o h√° localiza√ß√£o
                listaCard.find('.location-indicator').remove();
            }
            
            // Efeito visual de atualiza√ß√£o
            listaCard.addClass('update-pulse');
            setTimeout(function() {
                listaCard.removeClass('update-pulse');
            }, 1500);
            
            // Mensagem de sucesso
            if (typeof showMessage === 'function') {
                showMessage('success', 'Lista atualizada com sucesso!', true);
            }
            
            // Atualizar dashboard
            if (typeof atualizarDashboardStatsLocalmente === 'function') {
                atualizarDashboardStatsLocalmente();
            }
        },
        error: function(xhr, status, error) {
            console.error('DEBUG: Erro ao atualizar lista', { xhr, status, error });
            
            // Remover indicador de carregamento
            $('#modalEditarLista').removeClass('loading');
            
            // Processar erros
            let errorMessage = 'Erro ao atualizar a lista. Tente novamente.';
            let errors = {};
            
            try {
                const response = JSON.parse(xhr.responseText);
                if (response.message) {
                    errorMessage = response.message;
                }
                if (response.errors) {
                    errors = response.errors;
                }
            } catch (e) {
                console.error('Erro ao parsing da resposta:', e);
            }
            
            // Exibir erros de valida√ß√£o
            if (Object.keys(errors).length > 0) {
                // Limpar erros anteriores
                $('#formEditarLista .invalid-feedback').empty();
                $('#formEditarLista .is-invalid').removeClass('is-invalid');
                
                // Adicionar novas mensagens de erro
                for (const field in errors) {
                    const fieldId = `#editar_lista_${field}`;
                    $(fieldId).addClass('is-invalid');
                    $(fieldId).next('.invalid-feedback').text(errors[field]);
                }
                
                if (typeof showMessage === 'function') {
                    showMessage('danger', 'Corrija os erros no formul√°rio.', true);
                }
            } else {
                if (typeof showMessage === 'function') {
                    showMessage('danger', errorMessage, true);
                }
            }
        }
    });
});

// Fun√ß√£o auxiliar para validar coordenadas
function isValidCoordinate(lat, lng) {
    return lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
}

// Fun√ß√£o auxiliar para formatar coordenadas
function formatCoordinates(lat, lng) {
    if (!isValidCoordinate(lat, lng)) return 'Coordenadas inv√°lidas';
    
    const latDir = lat >= 0 ? 'N' : 'S';
    const lngDir = lng >= 0 ? 'L' : 'O';
    
    return `${Math.abs(lat).toFixed(6)}¬∞${latDir}, ${Math.abs(lng).toFixed(6)}¬∞${lngDir}`;
}

// Debug: Verificar se Leaflet foi carregado
$(window).on('load', function() {
    setTimeout(function() {
        if (typeof L !== 'undefined') {
            console.log('Leaflet carregado e pronto para uso');
            window.leafletLoaded = true;
        } else {
            console.warn('Leaflet n√£o foi carregado corretamente');
        }
    }, 1000);
});
</script>