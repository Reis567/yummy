{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}
{% block title %}Home{% endblock %}
{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}
{% block content %}
<!-- Dashboard Header -->
<div class="row mb-4 align-items-center">
   <div class="col-12 col-md-8 mb-3 mb-md-0">
      <h2 class="page-title">Minhas Listas</h2>
      <p class="text-muted">Bem-vindo(a) de volta, {{ request.user.first_name|default:request.user.username }}! Aqui estão suas listas de tarefas.</p>
   </div>
   <div class="col-12 col-md-4 d-flex justify-content-start justify-content-md-end">
      <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovaLista">
      <i class="fas fa-plus me-1"></i> Nova Lista
      </button>
   </div>
</div>
<!-- Dashboard Stats Cards -->
<div class="row mb-4">
   <div class="col-6 col-md-4 mb-3 mb-md-0">
      <div class="dashboard-card">
         <div class="dashboard-card-body">
            <div class="d-flex align-items-center">
               <div class="dashboard-icon me-2 me-md-3">
                  <i class="fas fa-list-check"></i>
               </div>
               <div>
                  <div class="stat-number">{{ total_listas }}</div>
                  <div class="stat-text">Listas</div>
               </div>
            </div>
         </div>
      </div>
   </div>
   <div class="col-6 col-md-4 mb-3 mb-md-0">
      <div class="dashboard-card">
         <div class="dashboard-card-body">
            <div class="d-flex align-items-center">
               <div class="dashboard-icon me-2 me-md-3">
                  <i class="fas fa-spinner"></i>
               </div>
               <div>
                  <div class="stat-number">{{ listas_em_andamento }}</div>
                  <div class="stat-text">Em Andamento</div>
               </div>
            </div>
         </div>
      </div>
   </div>
   <div class="col-12 col-md-4">
      <div class="dashboard-card">
         <div class="dashboard-card-body">
            <div class="d-flex align-items-center">
               <div class="dashboard-icon me-2 me-md-3">
                  <i class="fas fa-check-circle"></i>
               </div>
               <div>
                  <div class="stat-number">{{ listas_concluidas }}</div>
                  <div class="stat-text">Concluídas</div>
               </div>
            </div>
         </div>
      </div>
   </div>
</div>
<!-- Lista de Listas -->
<div class="row">
   <div class="col-12">
      {% if listas %}
      {% for lista in listas %}
      <div class="lista-card {{ lista.status }}">
         <div class="lista-card-header">
            <div class="d-flex">
               <div class="lista-icon me-2 me-md-3">
                  <i class="{{ lista.icone }}"></i>
               </div>
               <div class="pe-5">
                  <!-- Adicionado padding-right para evitar sobreposição com os botões -->
                  <h3 class="lista-title">{{ lista.nome }}</h3>
                  {% if lista.objetivo %}
                  <p class="lista-objetivo">{{ lista.objetivo }}</p>
                  {% endif %}
                  <div class="lista-meta">
                     <span>
                     <i class="fas fa-calendar-alt me-1"></i> Criada em {{ lista.data_criacao|date:"d/m/Y" }}
                     </span>
                     {% if lista.data_objetivo %}
                     <span>
                     <i class="fas fa-hourglass-half me-1"></i> 
                     {% if lista.dias_restantes < 0 %}
                     <span class="text-danger">Atrasada ({{ lista.dias_restantes|abs }} dias)</span>
                     {% elif lista.dias_restantes == 0 %}
                     <span class="text-warning">Vence hoje</span>
                     {% else %}
                     <span>{{ lista.dias_restantes }} dias restantes</span>
                     {% endif %}
                     </span>
                     {% endif %}
                     <span class="badge badge-status {{ lista.status }}">{{ lista.get_status_display }}</span>
                  </div>
               </div>
            </div>
            <div class="lista-actions">
               <a href="#" class="btn-icon view-lista" data-lista-id="{{ lista.id }}" title="Ver detalhes">
               <i class="fas fa-eye"></i>
               </a>
               <a href="#" class="btn-icon edit-lista" data-lista-id="{{ lista.id }}" title="Editar lista">
               <i class="fas fa-edit"></i>
               </a>
               <div class="dropdown d-inline-block">
                  <button class="btn-icon" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Mais opções">
                  <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                     <li><a class="dropdown-item add-item" href="#" data-lista-id="{{ lista.id }}"><i class="fas fa-plus me-2"></i> Adicionar item</a></li>
                     <li><a class="dropdown-item change-status" href="#" data-lista-id="{{ lista.id }}"><i class="fas fa-sync-alt me-2"></i> Mudar status</a></li>
                     <li>
                        <hr class="dropdown-divider">
                     </li>
                     <li><a class="dropdown-item delete-lista text-danger" href="#" data-lista-id="{{ lista.id }}"><i class="fas fa-trash me-2"></i> Excluir lista</a></li>
                  </ul>
               </div>
            </div>
         </div>
         <div class="lista-card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
               <h6 class="m-0">Itens</h6>
               <span class="text-muted small">{{ lista.itens.count }} total | {{ lista.porcentagem_concluida }}% concluído</span>
            </div>
            <div class="progress mb-3">
               <div class="progress-bar" role="progressbar" style="width: {{ lista.porcentagem_concluida }}%" aria-valuenow="{{ lista.porcentagem_concluida }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            {% if lista.itens.count > 0 %}
            <div class="lista-itens">
               {% for item in lista.itens.all|slice:":3" %}
               <div class="lista-item {{ item.prioridade }} {% if item.status == 'concluido' %}concluido{% endif %}">
                  <input type="checkbox" class="item-checkbox" {% if item.status == 'concluido' %}checked{% endif %} data-item-id="{{ item.id }}">
                  <span class="text-truncate">{{ item.nome }}</span>
               </div>
               {% endfor %}
               {% if lista.itens.count > 3 %}
               <div class="text-center mt-2">
                  <a href="#" class="btn btn-sm btn-outline-primary view-lista" data-lista-id="{{ lista.id }}">
                  Ver todos os {{ lista.itens.count }} itens
                  </a>
               </div>
               {% endif %}
            </div>
            {% else %}
            <div class="text-center py-3">
               <p class="text-muted mb-2">Esta lista ainda não tem itens.</p>
               <button class="btn btn-sm btn-outline-primary add-item" data-lista-id="{{ lista.id }}">
               <i class="fas fa-plus me-1"></i> Adicionar Item
               </button>
            </div>
            {% endif %}
         </div>
         <div class="lista-card-footer">
            <div class="d-flex justify-content-between align-items-center">
               <div class="d-flex flex-wrap gap-2">
                  <!-- Itens de prioridade alta -->
                  {% if lista.itens_alta_prioridade > 0 %}
                  <span title="Itens de prioridade alta">
                  <i class="fas fa-arrow-up text-danger me-1"></i>{{ lista.itens_alta_prioridade }}
                  </span>
                  {% endif %}
                  <!-- Itens de prioridade média -->
                  {% if lista.itens_media_prioridade > 0 %}
                  <span title="Itens de prioridade média">
                  <i class="fas fa-equals text-warning me-1"></i>{{ lista.itens_media_prioridade }}
                  </span>
                  {% endif %}
                  <!-- Itens de prioridade baixa -->
                  {% if lista.itens_baixa_prioridade > 0 %}
                  <span title="Itens de prioridade baixa">
                  <i class="fas fa-arrow-down text-success me-1"></i>{{ lista.itens_baixa_prioridade }}
                  </span>
                  {% endif %}
               </div>
               <a href="#" class="btn btn-sm btn-primary view-lista" data-lista-id="{{ lista.id }}">
               <i class="fas fa-eye me-1"></i> Ver Lista
               </a>
            </div>
         </div>
      </div>
      {% endfor %}
      {% else %}
      <div class="empty-state">
         <i class="fas fa-clipboard-list"></i>
         <h4>Nenhuma lista encontrada</h4>
         <p>Você ainda não criou nenhuma lista de tarefas. Comece criando sua primeira lista para organizar suas atividades.</p>
         <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovaLista">
         <i class="fas fa-plus "></i>
         </button>
      </div>
      {% endif %}
   </div>
</div>
<!-- Incluir o modal para criação de lista -->
{% include "modal/modal_nova_lista.html" %}
{% endblock %}
{% block extra_js %}
<script>
   // Inicialização da página
   $(document).ready(function() {
       // Handler para o formulário de nova lista
       $('#formNovaLista').on('submit', function(e) {
           e.preventDefault();
           
           // Obter dados do formulário
           const formData = {
               nome: $('#id_nome').val(),
               objetivo: $('#id_objetivo').val(),
               data_objetivo: $('#id_data_objetivo').val(),
               status: $('#id_status').val(),
               cor: $('#id_cor').val(),
               icone: $('#id_icone').val()
           };
           
           // Enviar para a API
           $.ajax({
               url: '/api/listas/criar/',
               type: 'POST',
               contentType: 'application/json',
               data: JSON.stringify(formData),
               beforeSend: function(xhr) {
                   xhr.setRequestHeader('X-CSRFToken', $('input[name="csrfmiddlewaretoken"]').val());
               },
               success: function(response) {
                   // Fechar o modal
                   $('#modalNovaLista').modal('hide');
                   
                   // Exibir mensagem de sucesso
                   showMessage('success', 'Lista criada com sucesso!');
                   
                   // Recarregar a página para mostrar a nova lista
                   setTimeout(function() {
                       location.reload();
                   }, 1000);
               },
               error: function(xhr) {
                   // Exibir mensagem de erro
                   const response = xhr.responseJSON;
                   showMessage('danger', response.message || 'Erro ao criar lista. Tente novamente.');
                   
                   // Exibir erros de validação no formulário
                   if (response.errors) {
                       showFormErrors(response.errors);
                   }
               }
           });
       });
       
       // Marcar/desmarcar item como concluído
       $('.item-checkbox').on('change', function() {
           const itemId = $(this).data('item-id');
           const concluido = $(this).prop('checked');
           const novoStatus = concluido ? 'concluido' : 'pendente';
           
           // Atualizar a classe do item
           if (concluido) {
               $(this).closest('.lista-item').addClass('concluido');
           } else {
               $(this).closest('.lista-item').removeClass('concluido');
           }
           
           // Enviar para a API
           $.ajax({
               url: `/api/itens/${itemId}/status/`,
               type: 'POST',
               contentType: 'application/json',
               data: JSON.stringify({ status: novoStatus }),
               beforeSend: function(xhr) {
                   xhr.setRequestHeader('X-CSRFToken', $('input[name="csrfmiddlewaretoken"]').val());
               },
               success: function(response) {
                   showMessage('success', 'Status do item atualizado!');
               },
   
   error: function() {
                   showMessage('danger', 'Erro ao atualizar status do item.');
                   // Reverter a mudança no checkbox
                   $('.item-checkbox[data-item-id="'+itemId+'"]').prop('checked', !concluido);
               }
           });
       });
       
       // Adicionar item à lista
       $('.add-item').on('click', function(e) {
           e.preventDefault();
           const listaId = $(this).data('lista-id');
           // Redirecionar para a página da lista ou abrir modal de novo item
           alert('Funcionalidade para adicionar item à lista ' + listaId + ' será implementada em breve!');
       });
       
       // Ver lista completa
       $('.view-lista').on('click', function(e) {
           e.preventDefault();
           const listaId = $(this).data('lista-id');
           // Redirecionar para a página da lista
           window.location.href = `/listas/${listaId}/`;
       });
       
       // Editar lista
       $('.edit-lista').on('click', function(e) {
           e.preventDefault();
           const listaId = $(this).data('lista-id');
           // Abrir modal de edição ou redirecionar
           alert('Funcionalidade para editar a lista ' + listaId + ' será implementada em breve!');
       });
       
       // Excluir lista
       $('.delete-lista').on('click', function(e) {
           e.preventDefault();
           const listaId = $(this).data('lista-id');
           
           if (confirm('Tem certeza que deseja excluir esta lista? Esta ação não pode ser desfeita.')) {
               $.ajax({
                   url: `/api/listas/${listaId}/excluir/`,
                   type: 'POST',
                   beforeSend: function(xhr) {
                       xhr.setRequestHeader('X-CSRFToken', $('input[name="csrfmiddlewaretoken"]').val());
                   },
                   success: function(response) {
                       showMessage('success', 'Lista excluída com sucesso!');
                       // Remover a lista da interface
                       $(`[data-lista-id="${listaId}"]`).closest('.lista-card').fadeOut(300, function() {
                           $(this).remove();
                           
                           // Se não houver mais listas, mostrar o estado vazio
                           if ($('.lista-card').length === 0) {
                               location.reload();
                           }
                       });
                   },
                   error: function() {
                       showMessage('danger', 'Erro ao excluir lista. Tente novamente.');
                   }
               });
           }
       });
       
       // Função auxiliar para exibir mensagens
       function showMessage(type, message) {
           const alertHtml = `
               <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                   ${message}
                   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
               </div>
           `;
           
           // Inserir alerta no topo da página
           $('.page-title').before(alertHtml);
           
           // Auto-remover após 5 segundos
           setTimeout(function() {
               $('.alert').alert('close');
           }, 5000);
       }
       
       // Função para exibir erros de formulário
       function showFormErrors(errors) {
           // Limpar erros anteriores
           $('.invalid-feedback').remove();
           $('.is-invalid').removeClass('is-invalid');
           
           // Adicionar novas mensagens de erro
           for (const field in errors) {
               const input = $(`#id_${field}`);
               input.addClass('is-invalid');
               input.after(`<div class="invalid-feedback">${errors[field]}</div>`);
           }
       }
       
       // Ajuste para melhorar a experiência em dispositivos móveis
       function adjustForMobile() {
           // Se a largura da tela for menor que 576px (dispositivos muito pequenos)
           if (window.innerWidth < 576) {
               // Reduzir o número de itens mostrados em cada lista
               $('.lista-item').each(function(index) {
                   if (index > 1) { // Mostrar apenas os 2 primeiros itens em telas muito pequenas
                       $(this).hide();
                   }
               });
               
               // Mostrar o botão "Ver todos" para listas com mais de 2 itens
               $('.lista-itens').each(function() {
                   const items = $(this).find('.lista-item');
                   if (items.length > 2) {
                       // Se o botão "Ver todos" já não existir, adicione-o
                       if ($(this).find('.btn-view-all').length === 0) {
                           const listaId = $(this).closest('.lista-card').find('[data-lista-id]').first().data('lista-id');
                           const totalItems = items.length;
                           $(this).append(`
                               <div class="text-center mt-2">
                                   <a href="#" class="btn btn-sm btn-outline-primary view-lista btn-view-all" data-lista-id="${listaId}">
                                       Ver todos os ${totalItems} itens
                                   </a>
                               </div>
                           `);
                       }
                   }
               });
           } else {
               // Em telas maiores, mostrar até 3 itens conforme o design original
               $('.lista-item').show();
               $('.btn-view-all').parent().remove();
           }
       }
       
       // Executar o ajuste na inicialização
       adjustForMobile();
       
       // Executar o ajuste quando a tela for redimensionada
       $(window).on('resize', function() {
           adjustForMobile();
       });
   });
</script>
{% endblock %}